<!DOCTYPE html>
<html>
<head>
    <title>Beam Health – Patient Intake</title>
    <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 700px;
    }
    h2 {
      margin-top: 40px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      margin-top: 5px;
      padding: 8px;
      width: 100%;
    }
    .hidden {
      display: none;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
    .slot {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    .slot:hover {
      background-color: #f5f5f5;
    }
  </style>
</head>

<body>

<h1>Beam Health – Patient Acquisition & Scheduling</h1>

<!-- Patient Intake -->
<h2>1️⃣ Patient Intake</h2>
<form id="intake-form">
    <label>First Name <input required id="first_name"></label>
    <label>Last Name <input required id="last_name"></label>
    <label>Date of Birth <input type="date" required id="dob"></label>
    <label>Email <input type="email" required id="email"></label>

    <label>Insurance Payer
        <select id="insurance_payer">
            <option>Aetna</option>
            <option>BlueCross</option>
            <option>Medicare</option>
            <option>UnitedHealthcare</option>
        </select>
    </label>

    <label>Insurance Plan
        <select id="insurance_plan">
            <option>PPO</option>
            <option>HMO</option>
            <option>Preferred</option>
            <option>Part B</option>
            <option>Basic</option>
        </select>
    </label>

    <button type="submit">Submit Intake</button>
</form>

<!-- Eligibility -->
<div id="eligibility-section" class="hidden">
    <h2>2️⃣ Insurance Eligibility</h2>
    <p id="eligibility-message"></p>
</div>

<!-- Appointments -->
<div id="appointments-section" class="hidden">
    <h2>3️⃣ Available Appointments</h2>
    <div id="appointments"></div>
</div>

<script>
let patientId = null;

// ---------- Intake ----------
document.getElementById("intake-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const payload = {
    first_name: first_name.value,
    last_name: last_name.value,
    dob: dob.value,
    email: email.value,
    insurance_payer: insurance_payer.value,
    insurance_plan: insurance_plan.value
  };

  const res = await fetch("/intake", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  patientId = data.patient_id;

  const msg = document.getElementById("eligibility-message");
  const section = document.getElementById("eligibility-section");

  section.classList.remove("hidden");

  if (data.eligibility.eligible) {
    msg.innerHTML = `<span class="success">
      Eligible ✅ – Estimated Copay: $${data.eligibility.copay}
    </span>`;
    loadAppointments();
  } else {
    msg.innerHTML = `<span class="error">
      Not Eligible ❌ – ${data.eligibility.reason}
    </span>`;
  }
});

// ---------- Load Appointments ----------
async function loadAppointments() {
  const res = await fetch("/appointments/available");
  const slots = await res.json();

  const container = document.getElementById("appointments");
  container.innerHTML = "";
  document.getElementById("appointments-section").classList.remove("hidden");

  slots.forEach(slot => {
    const div = document.createElement("div");
    div.className = "slot";
    div.innerText = `${slot.start} (${slot.slot_duration} mins)`;
    div.onclick = () => bookAppointment(slot.id);
    container.appendChild(div);
  });
}

// ---------- Book Appointment ----------
async function bookAppointment(appointmentId) {
  const res = await fetch(`/appointments/${appointmentId}/book`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ patient_id: patientId })
  });

  const data = await res.json();
  alert("✅ Appointment booked successfully!");
}
</script>

</body>
</html>
